<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin — Vendor Approvals | Wedding Hub</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    .container{max-width:980px;margin:28px auto;padding:16px}
    .card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .vendor-row{display:flex;gap:12px;align-items:flex-start;padding:12px;border-bottom:1px solid #f3f4f6}
    .vendor-media{width:120px;height:80px;background:#f3f4f6;border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .vendor-media img{width:100%;height:100%;object-fit:cover}
    .vendor-info{flex:1}
    .actions{display:flex;gap:8px}
    .btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .btn-approve{background:#16a34a;color:#fff}
    .btn-reject{background:#ef4444;color:#fff}
    .hint{color:#6b7280;font-size:13px}
    input.admin-secret{padding:8px;border-radius:8px;border:1px solid #e6e6e6;width:320px;margin-right:8px}
    .topbar{display:flex;gap:12px;align-items:center;margin-bottom:12px}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="topbar">
        <h2 style="margin:0">Admin — Vendor Approvals</h2>
        <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
          <input id="adminSecret" class="admin-secret" placeholder="Admin secret (or leave empty to use token)" />
          <button id="refreshBtn" class="btn">Refresh</button>
        </div>
      </div>

      <div id="msg" class="hint"></div>

      <div id="list"></div>
      <div id="empty" class="hint" style="display:none;padding:18px;text-align:center">No pending vendors.</div>
    </div>
  </div>

<script src="env.js"></script>
<script>
(function () {
  const BASE_URL = window.BASE_URL || '';
  const listEl = document.getElementById('list');
  const msg = document.getElementById('msg');
  const refreshBtn = document.getElementById('refreshBtn');
  const adminSecretInput = document.getElementById('adminSecret');
  const emptyEl = document.getElementById('empty');

  function showMsg(t, isError) {
    msg.textContent = t || '';
    msg.style.color = isError ? '#ef4444' : '#0f5132';
  }

  function getHeaders() {
    const headers = {};
    const token = localStorage.getItem('token');
    const secret = adminSecretInput.value && adminSecretInput.value.trim();
    if (token) headers['Authorization'] = 'Bearer ' + token;
    if (secret) headers['X-Admin-Secret'] = secret;
    return headers;
  }

  async function loadPending() {
    showMsg('Loading pending vendors...');
    listEl.innerHTML = '';
    emptyEl.style.display = 'none';
    try {
      const res = await fetch(`${BASE_URL.replace(/\/+$/, '')}/api/admin/vendors/pending`, {
        headers: getHeaders()
      });
      if (!res.ok) {
        const j = await res.json().catch(()=>({message:'Failed'}));
        showMsg('Error: ' + (j.message || 'Unable to fetch'), true);
        return;
      }
      const arr = await res.json();
      if (!arr || !arr.length) {
        emptyEl.style.display = 'block';
        showMsg('');
        return;
      }
      showMsg(`Found ${arr.length} pending vendor(s).`);
      arr.forEach(renderVendor);
    } catch (err) {
      console.error(err);
      showMsg('Error loading pending vendors', true);
    }
  }

  function renderVendor(v) {
    const row = document.createElement('div');
    row.className = 'vendor-row';

    const mediaWrap = document.createElement('div');
    mediaWrap.className = 'vendor-media';
    const img = document.createElement('img');
    img.src = v.selfie ? (v.selfie.startsWith('http') ? v.selfie : (BASE_URL + '/' + v.selfie.replace(/^\/+/, ''))) : 'images/placeholder.svg';
    img.alt = v.name || 'selfie';
    mediaWrap.appendChild(img);

    const info = document.createElement('div');
    info.className = 'vendor-info';
    info.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:start">
        <div>
          <div style="font-weight:700">${v.name || '—'}</div>
          <div class="hint">${v.service || '—'} • ${v.city || '—'}</div>
        </div>
        <div class="hint">${v.createdAt ? new Date(v.createdAt).toLocaleString() : ''}</div>
      </div>
      <div style="margin-top:8px;color:#374151">${v.about ? (v.about.length>200 ? v.about.slice(0,200)+'…' : v.about) : ''}</div>
      <div style="margin-top:10px" class="hint">
        Phone: ${v.phone || '—'} • Email: ${v.email || '—'} • Approved: ${v.approved ? 'Yes' : 'No'}
      </div>
    `;

    const actions = document.createElement('div');
    actions.className = 'actions';

    const approveBtn = document.createElement('button');
    approveBtn.className = 'btn btn-approve';
    approveBtn.textContent = 'Approve';
    approveBtn.onclick = () => doApprove(v._id, row);

    const rejectBtn = document.createElement('button');
    rejectBtn.className = 'btn btn-reject';
    rejectBtn.textContent = 'Reject';
    rejectBtn.onclick = () => {
      const reason = prompt('Rejection reason (optional):') || '';
      doReject(v._id, reason, row);
    };

    actions.appendChild(approveBtn);
    actions.appendChild(rejectBtn);

    row.appendChild(mediaWrap);
    row.appendChild(info);
    row.appendChild(actions);

    listEl.appendChild(row);
  }

  async function doApprove(id, rowEl) {
    if (!confirm('Approve this vendor?')) return;
    try {
      const res = await fetch(`${BASE_URL.replace(/\/+$/, '')}/api/admin/vendors/${id}/approve`, {
        method: 'POST',
        headers: getHeaders()
      });
      const json = await res.json();
      if (!res.ok) {
        alert(json.message || 'Failed to approve');
        return;
      }
      rowEl.remove();
      showMsg('Vendor approved.');
    } catch (err) {
      console.error(err);
      alert('Error approving vendor');
    }
  }

  async function doReject(id, reason, rowEl) {
    if (!confirm('Reject this vendor?')) return;
    try {
      const res = await fetch(`${BASE_URL.replace(/\/+$/, '')}/api/admin/vendors/${id}/reject`, {
        method: 'POST',
        headers: Object.assign({'Content-Type':'application/json'}, getHeaders()),
        body: JSON.stringify({ reason })
      });
      const json = await res.json();
      if (!res.ok) {
        alert(json.message || 'Failed to reject');
        return;
      }
      rowEl.remove();
      showMsg('Vendor rejected.');
    } catch (err) {
      console.error(err);
      alert('Error rejecting vendor');
    }
  }

  refreshBtn.addEventListener('click', loadPending);
  document.addEventListener('DOMContentLoaded', loadPending);
})();
</script>
</body>
</html>