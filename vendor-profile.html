<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Vendor Profile | Wedding Hub</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Page-specific lightweight styles (keeps visual parity with the site) */
    body{font-family:'Poppins',sans-serif;background:#fafafa;margin:0;color:#111}
    .navbar{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.04);position:sticky;top:0;z-index:50}
    .logo{font-weight:700;color:#e11d48}
    .container{max-width:1100px;margin:20px auto;padding:16px}
    .profile{display:grid;grid-template-columns:320px 1fr;gap:18px}
    .card{background:#fff;border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .media-grid{display:grid;grid-template-columns:1fr;gap:8px}
    .media-grid img{width:100%;height:220px;object-fit:cover;border-radius:8px}
    .vendor-name{font-size:20px;font-weight:700}
    .vendor-meta{color:#6b7280;margin-top:6px}
    .contact-actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    .btn{padding:10px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .btn-primary{background:#25D366;color:#fff}
    .btn-outline{background:#fff;border:1px solid #e11d48;color:#e11d48}
    .section{margin-bottom:12px}
    .map-embed{width:100%;height:240px;border-radius:8px;border:1px solid #e6e6e6}
    .muted{color:#6b7280}
    .review{border-top:1px dashed #eef2f7;padding-top:10px;margin-top:10px}
    .gallery-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin-top:8px}
    .gallery-item img,.gallery-item video{width:100%;height:120px;object-fit:cover;border-radius:8px;display:block}
    @media (max-width:880px){.profile{grid-template-columns:1fr}}
  </style>
</head>
<body>

<header class="navbar">
  <div style="display:flex;align-items:center;gap:16px;">
    <div class="logo">Wedding Hub</div>
    <nav class="nav-links">
      <a href="index.html">Home</a>
      <a href="vendors.html">Vendors</a>
    </nav>
  </div>

  <div id="authArea">
    <a id="vendorRegisterLink" href="vendor-register.html">Vendor Register</a>
    <a id="vendorLoginLink" href="vendor-login.html">Vendor Login</a>
    <span id="vendorWelcome" style="display:none"></span>
    <button id="vendorLogoutBtn" style="display:none">Logout</button>
  </div>
</header>

<main class="container">
  <div id="profileArea" class="profile">
    <div class="card" id="leftCol">
      <div class="media-grid" id="mediaGrid">
        <img id="mainMedia" src="images/placeholder.png" alt="Vendor image">
      </div>

      <div class="section">
        <div class="vendor-meta">Service</div>
        <div id="serviceText" class="muted">—</div>
      </div>

      <div class="section">
        <div class="vendor-meta">Location</div>
        <div id="locationText" class="muted">—</div>
      </div>

      <div class="section">
        <div class="vendor-meta">Since</div>
        <div id="sinceText" class="muted">—</div>
      </div>

      <div class="section">
        <div class="vendor-meta">Map</div>
        <div id="mapWrap" class="map-embed muted">Map loading…</div>
      </div>
    </div>

    <div class="card" id="rightCol">
      <div>
        <div class="vendor-name" id="vendorName">Vendor Name</div>
        <div class="vendor-meta" id="vendorAbout">Short description or about the vendor.</div>

        <div class="contact-actions" id="contactActions">
          <a id="callBtn" class="btn btn-outline" href="#">Call</a>
          <a id="whatsappBtn" class="btn btn-primary" href="#" target="_blank" rel="noopener">WhatsApp</a>
          <button id="bookBtn" class="btn btn-outline">Request Quote</button>
        </div>
      </div>

      <div class="section" style="margin-top:12px;">
        <h4>Photos & Videos</h4>
        <div id="gallery" class="gallery-grid"></div>
      </div>

      <div class="section">
        <h4>Reviews</h4>
        <div id="reviews">
          <div class="muted">No reviews yet.</div>
        </div>
      </div>

      <div class="section">
        <h4>Details</h4>
        <div class="muted" id="detailsBlock">Phone, Email, GST etc.</div>
      </div>
    </div>
  </div>
</main>

<footer style="text-align:center;padding:18px 0;color:#6b7280">© 2026 Wedding Hub</footer>

<script src="env.js"></script>
<script>
(function () {
  const BASE_URL = (window.BASE_URL || '').replace(/\/+$/, '');
  const qs = new URLSearchParams(window.location.search);
  const id = qs.get('id');

  const vendorNameEl = document.getElementById('vendorName');
  const vendorAboutEl = document.getElementById('vendorAbout');
  const serviceText = document.getElementById('serviceText');
  const locationText = document.getElementById('locationText');
  const sinceText = document.getElementById('sinceText');
  const detailsBlock = document.getElementById('detailsBlock');
  const gallery = document.getElementById('gallery');
  const mainMedia = document.getElementById('mainMedia');
  const mapWrap = document.getElementById('mapWrap');
  const callBtn = document.getElementById('callBtn');
  const whatsappBtn = document.getElementById('whatsappBtn');
  const bookBtn = document.getElementById('bookBtn');

  function safeUrlForMedia(url) {
    if (!url) return 'images/placeholder.png';
    if (/^https?:\/\//i.test(url)) return url;
    return (BASE_URL ? BASE_URL + '/' : '') + url.replace(/^\/+/, '');
  }

  function renderGalleryItem(src, isVideo) {
    const wrap = document.createElement('div');
    wrap.className = 'gallery-item';
    if (isVideo) {
      const v = document.createElement('video');
      v.src = safeUrlForMedia(src);
      v.controls = true;
      v.preload = 'metadata';
      v.style.height = '120px';
      wrap.appendChild(v);
    } else {
      const img = document.createElement('img');
      img.src = safeUrlForMedia(src);
      img.alt = 'media';
      img.addEventListener('click', () => {
        mainMedia.src = safeUrlForMedia(src);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
      wrap.appendChild(img);
    }
    return wrap;
  }

  async function fetchVendorFromApi(vendorId) {
    if (!BASE_URL) return null;
    try {
      const url = BASE_URL + '/api/vendors/' + encodeURIComponent(vendorId);
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) return null;
      const data = await res.json();
      return data;
    } catch (e) {
      console.warn('API vendor fetch failed', e);
      return null;
    }
  }

  async function fetchVendorFromJson(vendorId) {
    try {
      const res = await fetch('vendors.json', { cache: 'no-store' });
      if (!res.ok) return null;
      const data = await res.json();
      const vendors = data.vendors || [];
      return vendors.find(v => v.id === vendorId) || null;
    } catch (e) {
      console.warn('vendors.json fetch failed', e);
      return null;
    }
  }

  function formatPhone(p) {
    if (!p) return '';
    return String(p).replace(/\D/g, '');
  }

  function populateVendor(v) {
    if (!v) {
      vendorNameEl.textContent = 'Vendor not found';
      return;
    }

    vendorNameEl.textContent = v.name || 'No name';
    vendorAboutEl.textContent = v.about || (v.description || '') || '';
    serviceText.textContent = (v.services && v.services.join(', ')) || v.service || '—';
    locationText.textContent = v.city || v.location || '—';
    sinceText.textContent = v.createdAt ? new Date(v.createdAt).getFullYear() : (v.since || '');

    detailsBlock.innerHTML = `
      <div>Phone: ${v.phone || '—'}</div>
      <div>Email: ${v.email || '—'}</div>
      <div>Verified: ${v.verified ? 'Yes' : (v.approved ? 'Yes' : 'No')}</div>
    `;

    const phone = formatPhone(v.phone || v.contact || '');
    if (phone) {
      callBtn.href = 'tel:' + phone;
      whatsappBtn.href = 'https://wa.me/' + phone;
      callBtn.style.display = '';
      whatsappBtn.style.display = '';
    } else {
      callBtn.style.display = 'none';
      whatsappBtn.style.display = 'none';
    }

    // Gallery: supports up to 30 items (images or video)
    gallery.innerHTML = '';
    const mediaList = Array.isArray(v.gallery) && v.gallery.length ? v.gallery : (Array.isArray(v.media) ? v.media : (v.photos || []));
    if (mediaList && mediaList.length) {
      const list = mediaList.slice(0, 30);
      list.forEach(item => {
        // item can be string or object {url,type}
        let src = '';
        let isVideo = false;
        if (typeof item === 'string') {
          src = item;
          isVideo = /\.(mp4|webm|ogg)$/i.test(src);
        } else if (item && item.url) {
          src = item.url;
          isVideo = (item.type && item.type.startsWith('video')) || /\.(mp4|webm|ogg)$/i.test(src);
        }
        gallery.appendChild(renderGalleryItem(src, isVideo));
      });
      // set primary media to first available
      const first = list[0];
      const firstUrl = (typeof first === 'string') ? first : (first && first.url ? first.url : '');
      if (firstUrl) mainMedia.src = safeUrlForMedia(firstUrl);
    } else {
      gallery.innerHTML = '<div class="muted">No photos or videos available.</div>';
      mainMedia.src = 'images/placeholder.png';
    }

    // Map embed: accept v.location as {lat,lng} or v.lat/v.lng or v.location.coordinates [lng,lat]
    let lat = null, lng = null;
    if (v.lat && v.lng) { lat = parseFloat(v.lat); lng = parseFloat(v.lng); }
    else if (v.location && Array.isArray(v.location.coordinates)) {
      lng = parseFloat(v.location.coordinates[0]);
      lat = parseFloat(v.location.coordinates[1]);
    } else if (v.location && v.location.lat && v.location.lng) {
      lat = parseFloat(v.location.lat); lng = parseFloat(v.location.lng);
    }

    if (!isNaN(lat) && !isNaN(lng)) {
      const bboxDelta = 0.03;
      const mapUrl = `https://www.openstreetmap.org/export/embed.html?bbox=${lng-bboxDelta}%2C${lat-bboxDelta}%2C${lng+bboxDelta}%2C${lat+bboxDelta}&layer=mapnik&marker=${lat}%2C${lng}`;
      mapWrap.innerHTML = `<iframe class="map-iframe" src="${mapUrl}" style="width:100%;height:100%;border:0;border-radius:6px"></iframe>`;
    } else {
      mapWrap.textContent = 'Location not available';
    }

    // Request Quote button: opens mailto if email present else opens WhatsApp if available else shows alert
    bookBtn.addEventListener('click', () => {
      if (v.email) {
        const subject = encodeURIComponent('Request for quote — ' + (v.name || 'Vendor'));
        const body = encodeURIComponent('Hi ' + (v.name || '') + ',%0A%0AI would like to request a quote for your services.%0A%0AThanks,%0A[Your name]');
        window.location.href = `mailto:${v.email}?subject=${subject}&body=${body}`;
      } else if (phone) {
        window.open('https://wa.me/' + phone, '_blank');
      } else {
        alert('No contact email or phone available for this vendor.');
      }
    });
  }

  async function loadVendor() {
    if (!id) {
      vendorNameEl.textContent = 'Vendor not found';
      return;
    }

    // Try API first (live backend). If not available, fall back to vendors.json local file.
    let vendor = null;
    vendor = await fetchVendorFromApi(id);
    if (!vendor) {
      // fallback
      vendor = await fetchVendorFromJson(id);
    }

    populateVendor(vendor);
  }

  async function fetchVendorFromApi(vendorId) {
    if (!BASE_URL) return null;
    try {
      const url = BASE_URL + '/api/vendors/' + encodeURIComponent(vendorId);
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) return null;
      const data = await res.json();
      // normalize: ensure gallery array or media
      if (data && !data.gallery && data.media) data.gallery = data.media.map(m => (typeof m === 'string' ? m : (m.url || '')));
      return data;
    } catch (e) {
      console.warn('API vendor fetch failed', e);
      return null;
    }
  }

  async function fetchVendorFromJson(vendorId) {
    try {
      const res = await fetch('vendors.json', { cache: 'no-store' });
      if (!res.ok) return null;
      const data = await res.json();
      const vendors = data.vendors || [];
      const v = vendors.find(x => x.id === vendorId) || null;
      if (v && !v.gallery) {
        // Try to map gallery from known keys
        v.gallery = v.gallery || (v.media ? v.media.map(m => (typeof m === 'string' ? m : (m.url || ''))) : []);
      }
      return v;
    } catch (e) {
      console.warn('vendors.json fetch failed', e);
      return null;
    }
  }

  // Show logged-in vendor in header if any (local demo auth)
  try {
    const token = localStorage.getItem('token');
    const vendor = JSON.parse(localStorage.getItem('vendor') || 'null');
    if (token && vendor) {
      document.getElementById('vendorRegisterLink').style.display = 'none';
      document.getElementById('vendorLoginLink').style.display = 'none';
      const wok = document.getElementById('vendorWelcome');
      wok.style.display = 'inline-block';
      wok.textContent = vendor.name;
      const logout = document.getElementById('vendorLogoutBtn');
      logout.style.display = 'inline-block';
      logout.addEventListener('click', () => { localStorage.removeItem('token'); localStorage.removeItem('vendor'); location.reload(); });
    }
  } catch (e) { /* ignore */ }

  document.addEventListener('DOMContentLoaded', loadVendor);
})();
</script>

</body>
</html>